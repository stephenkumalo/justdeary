<!DOCTYPE html>

<html>
	<head>
		<script src="http://code.jquery.com/jquery.js"></script>
		<script type="text/javascript"
	    	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCi57alMzI6upazhiOfwQmwVxka_qSQ7s8&sensor=true">
	    </script>
	    <script type="text/javascript">
	    	var runningTotal;
	    	var map;
	    	var marker;
	    	var markers = new Array( );
	    	var infoWindow;


			function initialize() {
			var mapOptions = {
			  center: new google.maps.LatLng(-34.397, 150.644),
			  zoom: 8
			};
			map = new google.maps.Map(document.getElementById("map-canvas"),
			    mapOptions);
			}

			google.maps.event.addDomListener(window, 'load', initialize);

			function request(){

				clearOverlays( );

				console.log( document.location.port );
				var tag = {
					tag: $( "#text" ).val()
				};
				if( tag != ""){
					var ajax = $.ajax({
					  url: "http://localhost:" + document.location.port + " /insta",
					  data: tag,
					  beforeSend: function( xhr ) {
					    xhr.overrideMimeType( "text/plain;" );
					  }
					});

					ajax.done(function(data){
						var obj = JSON.parse(data);
						console.log( obj );
                        if( obj["meta"]["code"] == 200){
                        	for (var i = 0; i < obj["data"].length; i++) {
                        		if( obj["data"][i]["location"] != null){
                        			var position = new google.maps.LatLng(obj["data"][i]["location"]["latitude"], obj["data"][i]["location"]["longitude"]);
                        			
                        			var contentString = "<img src=" + obj["data"][i]["images"]["thumbnail"]["url"] + ">";
                        			
                        			infowindow = new google.maps.InfoWindow({
								    	maxWidth: 200
								  	});
                        			
                        			marker = new google.maps.Marker({
									    map:map,
									    draggable:false,
									    title: obj["data"][i]["location"]["name"],
									    animation: google.maps.Animation.DROP,
									    position: position
									});

									markers.push( marker );

									bindInfoWindow(marker, map, infowindow, contentString);

                        			marker.setMap( map );
                        		}
                        	};
                        }
                    });

					ajax.error(function(jqXHR, status, err){
						alert("We could not find any posts with the tag you specified");
					});
				}
			}

			function bindInfoWindow(marker, map, infoWindow, content){
				google.maps.event.addListener(marker, 'click', function() {
			        infowindow.setContent(content);
			        infowindow.open(map, marker);
			    });
			}

			function clearOverlays() {
			  if (markers) {
			    for (i in markers) {
			      markers[i].setMap(null);
			    }
			  }

			  markers = new Array( );
			}

			$( window ).load(function(){
	    		$( "#search-instagram" ).on("click", request);
	    	});
	    </script>
		<script src="bootstrap/js/bootstrap.min.js"></script>
		<style type="text/css">
		  html { height: 100% }
		  body { height: 100%; margin: 0; padding: 0 }
		  #map-canvas { height: 100%; z-index: 0; }
		  #search-bar {width: 340px; z-index: 10; position: absolute; margin-left: 75px; margin-top: 50px;}
		</style>
		<link href='http://fonts.googleapis.com/css?family=Alegreya+Sans+SC:100' rel='stylesheet' type='text/css'>
		<link href='http://fonts.googleapis.com/css?family=Lato:100' rel='stylesheet' type='text/css'>
		<link href='http://fonts.googleapis.com/css?family=Yellowtail' rel='stylesheet' type='text/css'>
		<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
		<link href="styles/styles.css" rel="stylesheet">
	</head>
	<body>
		<div id="search-bar">
			<h1 id="instamap">Instamap</h1>
			<input type="text" class="form-control" placeholder="Search for a tag" id="text" width="200">
			<button type="button" class="btn btn-primary" id="search-instagram" width="40">Search Instagram</button>
		</div>
		<div id="map-canvas" width="100%" height="100%"/>
	</body>
</html>